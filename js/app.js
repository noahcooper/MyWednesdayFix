/* MyWednesdayFix - app.js | Version: 0.4 (10-NOV-2013) */
(function(e){"use strict";var t={};t.data={currentView:"thisWeek",currentListOffset:"0",listIsLoading:true,isLastListPage:false,currentIssue:{},currentStore:{}};t.comicVine={getIssues:function(n){var r=e.extend({dateFilter:"current",offset:"0",callback:e.noop},n||{});t.data.listIsLoading=true;var i=new Date,s=i.getFullYear(),o=i.getMonth(),u=i.getDate(),a=i.getDay(),f=new Date(s,o,u-a),l=new Date(s,o,u+(6-a)),c=new Date(s,o,u+(7-a)),h="store_date:";if(r.dateFilter==="future"){h+=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+"|"+(c.getFullYear()+1)+"-"+(c.getMonth()+1)+"-"+c.getDate()}else{h+=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+"|"+l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()}e.ajax({dataType:"jsonp",url:"http://www.comicvine.com/api/issues/"+"?api_key=e21e187f67061d346687aeb81969a3fd2d1676fa"+"&field_list=api_detail_url,store_date,description,image,issue_number,volume"+"&filter="+h+"&sort=store_date:asc"+"&limit=24"+"&offset="+r.offset+"&format=jsonp"+"&json_callback=?",success:function(e){t.data.listIsLoading=false;t.data.currentOffset+=Number(e.number_of_page_results);if(t.data.currentOffset===Number(e.number_of_total_results)){t.data.isLastListPage=true}r.callback(e)}})},getIssue:function(t){var n=e.extend({callback:e.noop},t||{});e.ajax({dataType:"jsonp",url:"http://www.comicvine.com/api/issue/"+n.issueId+"/"+"?api_key=e21e187f67061d346687aeb81969a3fd2d1676fa"+"&field_list=store_date,description,image,issue_number,person_credits,volume"+"&format=jsonp"+"&json_callback=?",success:n.callback})}};t.googlePlaces={getComicStores:function(t){var n=e.extend({callback:e.noop},t||{});var r=new google.maps.places.PlacesService(document.getElementById("google-places")),i;if(n.latLng){i={location:"",radius:"40234",query:"comic book stores"}}else{i={query:"comic book stores near "+n.query}}r.textSearch(i,n.callback)},getComicStore:function(t){var n=e.extend({callback:e.noop},t||{});var r=new google.maps.places.PlacesService(document.getElementById("google-places"));r.getDetails({reference:n.reference},n.callback)}};t.utils={loadView:function(e,n){t.view[e]();t.data.currentView=e;if(!n){history.pushState({view:e},"",window.location.href.split("?")[0]+"?view="+e)}},showLoading:function(){e("#content-loading").show()},hideLoading:function(){e("#content-loading").hide()},setHeadline:function(t){e("#content-headline").html(t)},resetContent:function(){e("#content-wrap").html("");t.data.currentOffset=0;t.data.isLastListPage=false},formatTime:function(e){var t=e.substring(0,2),n=e.substring(0,2);if(t==0){n="12"}else if(e.substring(0,1)==0){n=e.substring(1,2)}else if(t>12){n=n-12}return n+":"+e.substring(2)+(t>=12?"pm":"am")}};t.ui={buildPanel:function(t){var n=e.extend({type:"panel-info"},t||{});return'<div class="panel '+n.type+'">'+(n.heading?'<div class="panel-heading">'+'<h3 class="panel-title">'+n.heading+"</h3>"+"</div>":"")+(n.body?'<div class="panel-body">'+n.body+"</div>":"")+"</div>"},buildIssuesList:function(n){var r=e.extend({issuesList:[]},n||{});e.each(r.issuesList,function(){var n=new Date,r=this.store_date.split("-"),i=r[0],s=r[1],o=r[2];if(e("#content-wrap .row").length===0||e("#content-wrap .row:last .feature-col").length===3){e("#content-wrap").append('<div class="row" />')}var u=this.api_detail_url.split("/issue/")[1].split("/")[0],a=this.volume.name,f=this.issue_number,l=this.description||"";l=l.split("<h4>List of covers and their creators:</h4>")[0];e("#content-wrap .row:last").append('<div class="col-sm-4 feature-col">'+t.ui.buildPanel({heading:'<a class="view-issue" href="#" data-issue="'+u+'">'+a+(f?" #"+f:"")+"</a>",body:(this.image.small_url?'<div class="feature-image-wrap">'+'<a href="#"><img alt="" src="'+this.image.small_url+'"></a>'+"</div>":"")+"<h3>In Stores "+s+"/"+o+"/"+i+"</h3>"+l+"<p>"+'<a class="btn btn-primary view-issue" href="#" data-issue="'+u+'">'+"Read more &"+"raquo;"+"</a>"+"</p>"})+"</div>")})},buildIssue:function(n){var r=e.extend({issue:{}},n||{}),i=r.issue,s=i.volume.name,o=i.issue_number,u=i.store_date.split("-"),a=u[0],f=u[1],l=u[2];e("#content-wrap").append('<div class="row">'+'<div class="col-xs-12 feature-col">'+t.ui.buildPanel({heading:s+(o?" #"+o:""),body:(i.image.medium_url?'<div class="col-md-6 feature-image-wrap">'+'<a href="#"><img alt="" src="'+i.image.medium_url+'"></a>'+"</div>":"")+'<h3 class="issue-store-date">'+"In Stores "+f+"/"+l+"/"+a+"</h3>"+'<div class="issue-desc">'+(i.description||"")+"</div>"})+"</div>"+"</div>");e(".issue-desc table").addClass("table");e(".issue-desc table th").each(function(t){if(e(this).is(':contains("Sidebar Location")')){e(this).closest("table").find("td:nth-child("+(t+1)+")").remove();e(this).remove()}});e.each(i.person_credits,function(t){e("#content-wrap .panel-body").append((t>0?"<br>":"")+'<span class="issue-credits">'+this.name+(this.role?", "+this.role:"")+"</span>")})},buildStoreLookup:function(){e("#content-wrap").append('<div class="panel panel-info">'+'<div class="panel-body">'+'<div class="pull-right" id="powered-by-google">'+'<img alt="Search Powered by Google" src="images/powered-by-google-on-white.png">'+"</div>"+'<form id="store-lookup">'+'<div class="form-group">'+'<input type="text" class="form-control" id="lookup-query" placeholder="Enter a city, state, or ZIP code">'+"</div>"+'<button type="submit" class="btn btn-default">Search</button>'+"</form>"+"</div>"+'<div class="list-group" id="store-results-list"></div>'+"</div>");e("#store-lookup").submit(function(n){n.preventDefault();e("#store-results-list a").remove();if(e("#lookup-query").val().length>0){t.utils.showLoading();t.googlePlaces.getComicStores({query:e("#lookup-query").val(),callback:function(n){t.utils.hideLoading();e.each(n,function(){e("#store-results-list").append('<a class="list-group-item view-store" href="#" data-reference="'+this.reference+'">'+'<h4 class="list-group-item-heading">'+this.name+"</h4>"+'<p class="list-group-item-text">'+this.formatted_address.split(", United States")[0]+"</p>"+"</a>")})}})}})},buildStore:function(n){var r=e.extend({place:{}},n||{}),i=r.place,s=i.formatted_phone_number,o=i.website,u=i.opening_hours,a=u?true:false,f,l;if(a){f=u.open_now,l=u.periods}e("#content-wrap").append('<div class="row">'+'<div class="col-xs-12 feature-col">'+t.ui.buildPanel({heading:i.name,body:'<p><span class="glyphicon glyphicon-pushpin"></span> '+i.formatted_address.split(", United States")[0]+"</p>"+(s?'<p><span class="glyphicon glyphicon-earphone"></span> '+s+"</p>":"")+(o?'<p><span class="glyphicon glyphicon-globe"></span> '+'<a target="_blank" href="'+o+'">'+o+"</a></p>":"")+(a?(f?'<p class="text-success">This store is open now</p>':'<p class="text-danger">This store is currently closed</p>')+"<p><strong>Hours:</strong></p>"+"<p>Monday: "+(l[1]?t.utils.formatTime(l[1].open.time)+" to "+t.utils.formatTime(l[1].close.time):"Closed")+"<br>"+"Tuesday: "+(l[2]?t.utils.formatTime(l[2].open.time)+" to "+t.utils.formatTime(l[2].close.time):"Closed")+"<br>"+"Wednesday: "+(l[3]?t.utils.formatTime(l[3].open.time)+" to "+t.utils.formatTime(l[3].close.time):"Closed")+"<br>"+"Thursday: "+(l[4]?t.utils.formatTime(l[4].open.time)+" to "+t.utils.formatTime(l[4].close.time):"Closed")+"<br>"+"Friday: "+(l[5]?t.utils.formatTime(l[5].open.time)+" to "+t.utils.formatTime(l[5].close.time):"Closed")+"<br>"+"Saturday: "+(l[6]?t.utils.formatTime(l[6].open.time)+" to "+t.utils.formatTime(l[6].close.time):"Closed")+"<br>"+"Sunday: "+(l[0]?t.utils.formatTime(l[0].open.time)+" to "+t.utils.formatTime(l[0].close.time):"Closed")+"</p>":"")})+"</div>"+"</div>")}};t.view={thisWeek:function(){t.utils.setHeadline("New This Week");t.utils.resetContent();t.utils.showLoading();t.comicVine.getIssues({callback:function(e){t.utils.hideLoading();t.ui.buildIssuesList({issuesList:e.results})}})},comingSoon:function(){t.utils.setHeadline("Coming Soon");t.utils.resetContent();t.utils.showLoading();t.comicVine.getIssues({dateFilter:"future",callback:function(e){t.utils.hideLoading();t.ui.buildIssuesList({issuesList:e.results})}})},viewIssue:function(){t.utils.resetContent();t.utils.showLoading();t.comicVine.getIssue({issueId:t.data.currentIssue.issueId,callback:function(e){t.utils.hideLoading();t.ui.buildIssue({issue:e.results})}})},findStore:function(){t.utils.setHeadline("Find a Comic Book Store");t.utils.resetContent();t.ui.buildStoreLookup()},viewStore:function(){t.utils.resetContent();t.utils.showLoading();t.googlePlaces.getComicStore({reference:t.data.currentStore.reference,callback:function(e){t.utils.hideLoading();t.ui.buildStore({place:e})}})}};t.utils.loadView("thisWeek");e(window).on("popstate",function(){if(history.state&&history.state.view&&history.state.view!=t.data.currentView){t.utils.loadView(history.state.view,true)}});e(".app-nav").click(function(n){n.preventDefault();t.utils.loadView(e(this).data("view"))});e("#content-wrap").on("click",".view-issue",function(n){n.preventDefault();t.data.currentIssue.issueId=e(n.target).data("issue");t.utils.loadView("viewIssue")});e("#content-wrap").on("click",".view-store",function(n){n.preventDefault();t.data.currentStore.reference=e(n.target).closest(".view-store").data("reference");t.utils.loadView("viewStore")});e(window).scroll(function(){if(e(window).scrollTop()+e(window).height()>e(document).height()-200&&(t.data.currentView==="thisWeek"||t.data.currentView==="comingSoon")&&!t.data.listIsLoading&&!t.data.isLastListPage){t.utils.showLoading();t.comicVine.getIssues({dateFilter:t.data.currentView==="comingSoon"?"future":"current",offset:t.data.currentOffset,callback:function(e){t.utils.hideLoading();t.ui.buildIssuesList({issuesList:e.results})}})}})})(jQuery)